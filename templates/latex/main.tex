% !TEX TS-program = LaTeX

% LianTze Lim templates helped a lot!
% https://www.overleaf.com/latex/examples/how-to-write-multilingual-text-with-different-scripts-in-latex/wfdxqhcyyjxz
% https://www.overleaf.com/blog/441-how-to-write-in-markdown-on-overleaf

% TODO:
% book/article cpl should be 66~72
% phone cpl should be 45~50

% book should have more margins
% article/phone/digital should have less margins

\documentclass[
	extrafontsizes, {{ info_target.font_size }},
	{% if info_target.reader == "print"  %}
		% print settings
		twoside,openright,
	{% elif info_target.reader == "digital"  %}
		% digital settings
		oneside,openany,
	{% else  %}
		\invalidReader,
	{% endif %}
	{% if info_target.size == "hd720"  %}
		% hd720 page_size settings (7.3774614536439in x 13.1154870287in)
		a4paper, % will still change in the geometry
	{% elif info_target.size == "wxgap"  %}
		% wxgap page_size settings (7.7765271812035in x 12.442443489926in)
		a4paper, % will still change in the geometry
	{% elif info_target.size == "xga"  %}
		% xga page_size settings (8.5151174390022in x 11.35348991867in)
		a4paper, % will still change in the geometry
	{% else  %}
		% some standard page_size setting
		{{ info_target.size }},
	{% endif %}
	{{ info_target.orientation }}
]{memoir}


{% if info_target.size == "hd720"  %}
	{% if info_target.orientation == "portrait"  %}
		% 50cpl @ 25pt hd720 portrait (phone portrait)
		\setstocksize{13.1154870287in}{7.3774614536439in} % #1 height, #2 width
		\settrimmedsize{13.1154870287in}{7.3774614536439in}{*} % same as stock
		\setlrmarginsandblock{20pt}{20pt}{*} % #1 left #2 right margins
		\setheadfoot{30pt}{37pt} % #1 headheight, #2 footskip
		\setulmarginsandblock{75pt}{38pt}{*} % #1 up #2 down margins
		\checkandfixthelayout
	{% else  %}
		% 55cpl @ 36pt hd720 landscape (phone landscape)
		\setstocksize{7.3774614536439in}{13.1154870287in} % #1 height, #2 width
		\settrimmedsize{7.3774614536439in}{13.1154870287in}{*} % same as stock
		\setlrmarginsandblock{80pt}{80pt}{*} % #1 left #2 right margins
		\setheadfoot{45pt}{27pt} % #1 headheight, #2 footskip
		\setulmarginsandblock{110pt}{30pt}{*} % #1 up #2 down margins
		\checkandfixthelayout
	{% endif %}
{% elif info_target.size == "wxgap"  %}
	\TODOWxgapMemoirPageConfiguration
{% elif info_target.size == "xga"  %}
	{% if info_target.orientation == "portrait"  %}
		% 66cpl @ 20pt xga portrait  (tablet portrait)
		\setstocksize{11.35348991867in}{8.5151174390022in} % #1 height, #2 width
		\settrimmedsize{11.35348991867in}{8.5151174390022in}{*} % same as stock
		\setlrmarginsandblock{25pt}{25pt}{*} % #1 left #2 right margins
		\setheadfoot{25pt}{30pt} % #1 headheight, #2 footskip
		\setulmarginsandblock{60pt}{40pt}{*} % #1 up #2 down margins
		\checkandfixthelayout
	{% else  %}
		% 66cpl @ 25pt xga landscape (tablet landscape)
		\setstocksize{8.5151174390022in}{11.35348991867in} % #1 height, #2 width
		\settrimmedsize{8.5151174390022in}{11.35348991867in}{*} % same as stock
		\setlrmarginsandblock{70pt}{70pt}{*} % #1 left #2 right margins
		\setheadfoot{30pt}{20pt} % #1 headheight, #2 footskip
		\setulmarginsandblock{75pt}{35pt}{*} % #1 up #2 down margins
		\checkandfixthelayout
	{% endif %}
{% else  %}
	% no customization on memoir's geometry were done..
{% endif %}

% geometry is only used for the cover page
% otherwise memoir tools are used instead of geometry package
\usepackage[pass]{geometry}

% TODO: remove this..?
% info.target.reset_footer_active
% info.target.reset_footer_depth: 0

% TODO: remove this..?
% info.target.clear_page_active: true
% info.target.clear_page_depth: 1

% language inclusion should be pretty early
{% include "latex/preamble/lang.tex" %}

% pdf size optimization
% TODO: put this meta-stuff into somewhere else
% perhaps also keep it after the language thing
\pdfminorversion=6
\pdfcompresslevel=9
\pdfobjcompresslevel=3

% shortcuts
\usepackage{xcolor}
\usepackage{latexsym}
% \def \utfbox {\nopagebreak\hfill □}
\def \utfboxraw {\hfill\color{black!08}$\Box$\color{black}}
\def \utfbox {\nopagebreak\utfboxraw}
\def \texthash {\#}
\def \endsec {\utfbox\clearpage}
\def \endfoot {\setcounter{footnote}{0}}

\setcounter{tocdepth}{->{{ info_target.toc_depth }}}

{% include "latex/preamble/footnote.tex" %}

{% include "latex/preamble/cover.tex" %}

\usepackage[footnotes,hybrid,underscores=false]{markdown}
%\usepackage[hybrid]{markdown}
\markdownSetup{
	rendererPrototypes={
    	link = {(links nor working for now)}
    	% link = {\href{=>#2}{=>#1}\footnoteB{\href{->#2}{=>{\ttfamily\scriptsize\relax$ \langle $#2$ \rangle $}}}}

		% old latex mobile
		% \markdownSetup{rendererPrototypes={
		%   link = {\href{=>#2}{=>#1}}
		% }}

		% old latex non-mobile
		% \markdownSetup{rendererPrototypes={
		% link = {\href{=>#2}{=>#1}\footnoteB{\href{=>#2}{=>{\ttfamily\scriptsize\relax$ \langle $#2$ \rangle $}}}}
		% }}
	},
	renderers = {
		olItemWithNumber = {\item},
	}
}

% TODO: must analyze this..
% idk why this hidelinks is in there..
\usepackage[hidelinks]{hyperref}


% TODO: review this stuff here
{% if sent_initial == "Zallman"  %}

	\input Zallman.fd
	\newcommand*\initialsfamily{\usefont{U}{Zallman}{xl}{n}}
	\renewcommand{\LettrineFontHook}{\initialsfamily}

	% TODO: Zallman may not fit alongside sans-serif fonts

	% I think this would only work for xelatex
	% in a xelatex version, with the uchar auto stuff,
	% before #2 and then after #2 the transitions had to be dis/enabled
	% \newcommand{\DECORATE}[3][]{\lettrine[lines=3,loversize=-.055,#1]{\disableTransitionRules#2\enableTransitionRules}{->#3}}

	% previous setting..
	% \newcommand{\DECORATE}[3][]{\lettrine[lines=3,loversize=-.055,#1]{->#2}{->#3}}

	\newcommand{\DECORATE}[3][]{\lettrine[lines=3,loversize=+.115,#1]{->#2}{->#3}}

{% else %}
	\newcommand{\DECORATE}[3][]{\lettrine[lines=3,loversize=-.055,#1]{->#2}{->#3}}
{% endif %}

% prev loversize: +0.115

% TODO: idk what this is
% \newfont{\initial}{wcmr17 at 48pt}
% \newcommand{\frstltr}[1]{
%     \newbox{\litera}
%     \savebox{\litera}{\hbox #1}
%     % \savebox{\litera}{\hbox{\initial #1}}
%     \vspace*{.2\ht\litera}\par\noindent
%     \begin{wrapfigure}{l}{.8\wd\litera}
%     \vbox to .05\ht\litera{\vss\usebox{\litera}\vspace*{-.65\ht\litera}}
%     \vspace*{-.2\ht\litera}
%     \end{wrapfigure}}
% \frstltr{Д}олжно работать!

\begin{document}%

% TODO: this will vary according to the taget setting
\chapterstyle{thatcher}
{% if info_target.reader == "print"  %}
	% print settings
	
	% (no changes)
{% elif info_target.reader == "digital"  %}
	% digital settings

	% removes header and footer information
	% (since those are metadata)
	\pagestyle{empty}
{% else  %}
	\invalidReader,
{% endif %}


\frontmatter

{% include "latex/cover/cover.tex" %}

\tableofcontents

{% if target == "book"  %}
	\clearpage
{% elif target == "article"  %}
{% endif %}

{% for md in info.content_files %}
	{% if loop.index0 == info_target.frontmatter_depth %}
		\mainmatter
	{% endif %}
\markdownInput{->{{md.0}}}%
{% endfor %}

\end{document}%
