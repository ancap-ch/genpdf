{% if def_lang.short == "jp"  %}
\usepackage[japanese]{babel}
{% else %}
\usepackage{polyglossia}%
{% endif %}


\usepackage{fontspec}%
\usepackage[space,CJKchecksingle]{xeCJK} % guess the CJKnumber, etc have no effect
\usepackage[Latin, Thai]{ucharclasses}% TODO: add CJK

\usepackage{xltxtra}

% installed fonts: 
% fandol and wadalab (cjk-fonts)
% Linux Libertine OpenType
% IPAex font OTF http://ipafont.ipa.go.jp/
% tlwg OTF fonts https://www.hawaii.edu/thai/thaifonts/ 
%  ftp://linux.thai.net/pub/thailinux/software/fonts-tlwg/fonts/

{% if def_lang.short == "jp"  %}
\setCJKmainfont[Script=CJK]{MS Mincho} % for \rmfamily
\setCJKsansfont[Script=CJK]{MS Gothic} % for \sffamily
\setCJKmonofont[Script=CJK]{MS Gothic}
\XeTeXlinebreaklocale "ja"  %% Zeilenumbruch für japanische Texte
\XeTeXlinebreakskip=0em plus 0.1em minus 0.01em
\usepackage{setspace}
{% elif def_lang.short == "zh" %}
%\setCJKmainfont[
%  BoldFont=WenQuanYi Zen Hei,
%  ItalicFont=AR PL KaitiM GB]
%  {AR PL SungtiL GB}
%\setCJKsansfont{Noto Sans CJK SC}
%\setCJKmonofont{cwTeXFangSong}
{% elif def_lang.short == "th" %}
\setmainlanguage[numerals=thai]{thai}%
\XeTeXlinebreaklocale "th_TH"
\XeTeXlinebreakskip = 0pt plus 1pt  
{% else %}
\setmainlanguage{->{{def_lang.long}}}%
{% endif %}

{% if def_lang.short == "jp"  %}
{% elif def_lang.short == "zh" %}
{% else %}
    {% for lang in other_langs %}
        {% if lang.short == "jp"  %}

\setCJKmainfont[Script=CJK]{MS Mincho} % for \rmfamily
\setCJKsansfont[Script=CJK]{MS Gothic} % for \sffamily
\setCJKmonofont[Script=CJK]{MS Gothic}
\setotherlanguage{->{{lang.long}}}%
        {% elif lang.short == "zh"  %}
        {% elif lang.short == "ko"  %}
        {% else %}
\setotherlanguage{->{{lang.long}}}%
        {% endif %}
    {% endfor %}
{% endif %}

\defaultfontfeatures{Ligatures=TeX}%


\newfontfamily\defaultfont{Linux Libertine O}% Code2000
\newfontfamily\latinfont{Linux Libertine O}%
\newfontfamily\thaifont[Script=Thai]{Norasi}%
\newfontfamily{\thaifonttt}[Script=Thai]{TlwgMono}
%\newfontfamily{\cjkfont}{HAN NOM A}
%\newfontfamily{\unifiedCJKfont}{SimSun-ExtB}
%\newCJKfontfamily\japanesefont{IPAex明朝}
%\setCJKfamilyfont{cjk-vert}[Script=CJK,RawFeature=vertical]{IPAex明朝}
%\newCJKfontfamily\koreafont{Baekmuk Batang}

\setDefaultTransitions{\defaultfont}{}

\setTransitionsForLatin{\latinfont}{}
%\setTransitionsForCJK{\cjkfont}{}
%\setTransitionsForJapanese{\japanesefont}{}
%\setTransitionTo{CJKUnifiedIdeographsExtensionB}{\unifiedCJKfont}
\setTransitionTo{Thai}{\thaifont}